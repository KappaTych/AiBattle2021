<!DOCTYPE html>
<html>

<head>
    <title>Ai Battle</title>
    <link href="styles/style.css" rel="stylesheet" type="text/css">
    <script src="scripts/ResourceLoader.js"></script>
    <script src="scripts/GameObject.js"></script>
    <script src="scripts/MovableObject.js"></script>
    <script src="scripts/StaticObject.js"></script>
    <script src="scripts/Scene.js"></script>
    <script src="scripts/SafeEval.js"></script>
    <script src="scripts/WorkerWaraper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ace.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="buttonWrapper">
            <button class="tab-button active buttonMenu" style="border-top-left-radius: 10px;" data-id="controllerEditorTab">Controller editor</button>
            <button class="tab-button buttonMenu" data-id="mapEditorTab">Map editor</button>
            <button class="tab-button buttonMenu" style="border-top-right-radius: 10px;" data-id="gameTab">Game</button>
        </div>
        <div class="contentWrapper">
            <div class="content active" id="controllerEditorTab">
                <table border="2" cellpadding="0" cellspacing="0" margin="auto" align="center" class="fixed">
                    <tr>
                        <td width="70%" height="100%">
                            <div id="editor1_wrapper" class="app_editor_wrapper">
                                <div id="controllerEditorText" class="app_editor"></div>
                                <div>
                                    <button onclick="SaveController()">SaveAs</button>
                                    <button onclick="LoadAndSetController()">Load</button>
                                    <input id="controllerFileName">
                                </div>
                            </div>
                        </td>
                        <td width="30%" height="100%" vertical-align="top">
                            <div class="scroll">
                                <div name="controllerLoader">
                                    <label>Loaded controllers</label>
                                    <ul name="controllerUl" id="controllerUl"></ul>
                                    <input type="file" name="controllerFile" id="controllerFile">
                                    <button onclick="AddController()">Load controller</button>
                                    <button onclick="ClearControllers()">Clear controllers</button>
                                    <br>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="content" id="mapEditorTab">
                <table border="2" cellpadding="0" cellspacing="0" margin="auto" align="center" class="fixed">
                    <tr>
                        <td width="70%" height="100%">
                            <div id="editor2_wrapper" class="app_editor_wrapper">
                                <div id="mapEditorText" class="app_editor"></div>
                                <div>
                                    <button onclick="SaveMap()">Save As</button>
                                    <button onclick="LoadAndSetMap()">Load</button>
                                    <input id="mapFileName">
                                </div>
                            </div>
                        </td>
                        <td width="30%" height="100%" vertical-align="top">
                            <div class="scroll">
                                <div name="mapLoader">
                                    <label>Loaded maps</label>
                                    <ul name="mapsUl" id="mapsUl"></ul>
                                    <input type="file" name="mapFile" id="mapFile">
                                    <button onclick="AddMap()">Load map</button>
                                    <button onclick="ClearMaps()">clear maps</button>
                                    <br>
                                    <button id="updateMapPreview" onclick="UpdateMapPreview()">Update map preview</button>
                                    <br>
                                    <div class="scroll">
                                        <canvas id="mapPreview" width="0" height="0"></canvas>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="content" id="gameTab">
                <table border="2" cellpadding="0" cellspacing="0" margin="auto" align="center" class="fixed">
                    <tr>
                        <td width="70%" height="100%">
                            <div id="mainWindowContainer" class="scroll">
                                <canvas id='main-window'></canvas>
                            </div>
                        </td>
                        <td width="30%" height="100%" vertical-align="top">
                            <div class="scroll">
                                <div name="selectMap">
                                    <label>Selected map file</label>
                                    <select name="mapList" onchange="SetMap()" id="mapList"></select>
                                    <!-- <button onclick="SetMap()">SetMap</button> -->
                                </div>

                                <div name="mapInfoDiv" id="mapInfoDiv">
                                    <label> Width:</label>
                                    <label id="mapWidth">Nan</label>
                                    <br>
                                    <label> Height:</label>
                                    <label id="mapHeight">Nan</label>
                                    <br>
                                    <label> Bots:</label>
                                    <ul id="botsList"></ul>
                                    <br>
                                    <label> Turns:</label>
                                    <label id="turnsCount"> Nan:</label>
                                    <br>
                                    <button onclick="StartGame()">Start Game</button>
                                </div>

                                <div name="gameTurnsControllerDiv" id="gameTurnsControllerDiv">
                                    <button onclick="NextStep()">Next step</button>
                                    <br>
                                    <button onclick="NextStepWithTimer()">Next step with timer</button>
                                    <input type="range" min="10" max="1000" step="1" id="botTurnTime" oninput="UpdateOutputForInputRange('botTurnTimeOutput',this.value)">
                                    <output id="botTurnTimeOutput">0</output>
                                    <label for="botTurnTime">Bot turn time ms</label>
                                    <br>
                                    <button onclick="AutoStep()">Auto step</button>
                                    <input type="range" min="10" max="1000" step="1" id="turnTime" oninput="UpdateOutputForInputRange('turnTimeOutput',this.value)">
                                    <output id="turnTimeOutput">0</output>
                                    <label for="turnTime">Turns period ms</label>
                                </div>

                                <div name="renderSettingsDiv" id="renderSettingsDiv">
                                    <button onclick="UpdateRender()">Update render</button>
                                    <button onclick="AutoSizeRender()">Autosize render</button>
                                    <input type="range" min="20" max="500" step="1" id="tileSize" oninput="UpdateOutputForInputRange('tileSizeOutput',this.value)">
                                    <output id="tileSizeOutput">0</output>
                                    <label for="tileSize">Tile size</label>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        function UpdateOutputForInputRange(name, value) {
            document.getElementById(name).value = value;
        }

        function UpdateMapPreview() {
            try {
                mapEditorScene = new Scene(MapInfo.LoadMapFromJson(mapEditor.getValue()), []);
                mapEditorScene.Render(document.getElementById("mapPreview"), 30);
            } catch (error) {
                alert(error);
                return;
            }

        }

        function InitTabs() {
            const tabs = document.querySelector(".wrapper");
            const tabButton = document.querySelectorAll(".tab-button");
            const contents = document.querySelectorAll(".content");

            tabs.onclick = function(e) {
                const id = e.target.dataset.id;
                if (id) {
                    tabButton.forEach(btn => {
                        btn.classList.remove("active");
                    });
                    e.target.classList.add("active");

                    contents.forEach(content => {
                        content.classList.remove("active");
                    });
                    const element = document.getElementById(id);
                    element.classList.add("active");

                    StopAutoStep();
                }
            }
        }

        function IsNameValid(name) {
            return !(name === null || name === undefined || name.length == 0);
        }

        function SetMapToEditor(name) {
            if (IsNameValid(document.getElementById("mapFileName").value))
                SaveMap();
            if (!MapExistInPool(name)) {
                alert("Map not found");
                return;
            }
            mapEditor.setValue(GetObjectFromStorageByName(name));
            document.getElementById("mapFileName").value = name;
        }

        function SetControllerToEditor(name) {
            if (IsNameValid(document.getElementById("controllerFileName").value))
                SaveController();
            if (!ControllerExistInPool(name)) {
                alert("Map not found");
                return;
            }
            controllerEditor.setValue(GetObjectFromStorageByName(name));
            document.getElementById("controllerFileName").value = name;
        }

        function DeleteController(name) {
            RemoveControllerFromPool(name);
            UpdateAllControllerListsAndUls();
        }

        function DeleteMap(name) {
            RemoveMapFromPool(name);
            UpdateAllMapListsAndUls();
        }

        function SaveController() {
            let name = document.getElementById("controllerFileName").value;
            if (!IsNameValid(name)) {
                alert("bad name");
                return;
            }
            AddControllerToPool(controllerEditor.getValue(), name);
            UpdateAllControllerListsAndUls();
        }

        function LoadAndSetController() {
            let name = document.getElementById("controllerFileName").value;
            if (!IsNameValid(name)) {
                alert("bad name");
                return;
            }
            SetControllerToEditor(name);
        }

        function SaveMap() {
            let name = document.getElementById("mapFileName").value;
            if (!IsNameValid(name)) {
                alert("bad name");
                return;
            }

            try {
                if (!MapInfo.IsJsonValid(mapEditor.getValue())) {
                    return;
                }
            } catch (error) {
                alert(error);
                return;
            }

            AddMapToPool(mapEditor.getValue(), name);
            UpdateAllMapListsAndUls();
        }

        function LoadAndSetMap() {
            let name = document.getElementById("mapFileName").value;
            if (!IsNameValid(name)) {
                alert("bad name");
                return;
            }
            SetMapToEditor(name);
        }

        function UpdateSelect(select, names) {
            if (names == null && names == undefined)
                return;
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
            for (let i = 0; i < names.length; ++i) {
                var option = document.createElement("option");
                option.text = names[i];
                select.add(option);
            }
        }

        function UpdateEditorUl(ul, names, onDelete, onEdit) {
            if (names == null && names == undefined)
                return;

            while (ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }

            for (let i = 0; i < names.length; ++i) {
                let li = document.createElement("li");

                let deleteButton = document.createElement("button");
                deleteButton.classList.add("delete_button");
                deleteButton.innerHTML = "Delete";
                deleteButton.onclick = function() {
                    onDelete(names[i]);
                }

                let editButton = document.createElement("button");
                editButton.classList.add("edit_button");
                editButton.innerHTML = "Edit";
                editButton.onclick = function() {
                    onEdit(names[i]);
                }

                li.appendChild(deleteButton);
                li.appendChild(editButton);
                li.appendChild(document.createTextNode(names[i]));
                ul.appendChild(li);
            }
        }

        function AddNewObjectToStorage(inputName, pullName, updateFunction, checkDataFunction) {
            let inputFile = document.getElementById(inputName);
            if (inputFile.files.length > 0) {
                for (let i = 0; i < inputFile.files.length; ++i) {
                    let reader = new FileReader();
                    reader.readAsText(inputFile.files[i]);
                    reader.onload = function() {
                        if (checkDataFunction !== null && checkDataFunction !== undefined) {
                            try {
                                if (checkDataFunction(reader.result)) {
                                    AddToPool(reader.result, inputFile.files[i].name, pullName);
                                    updateFunction();
                                } else {
                                    alert("Wrong format");
                                    return;
                                }
                            } catch (error) {
                                alert(error);
                                return;
                            }

                        } else {
                            AddToPool(reader.result, inputFile.files[i].name, pullName);
                            updateFunction();
                        }
                    };

                    reader.onerror = function() {
                        console.log(reader.error);
                    };
                }
            }
        }

        function AddMap() {
            AddNewObjectToStorage("mapFile", mapsPoolName, UpdateAllMapListsAndUls, MapInfo.IsJsonValid);
        }

        function ClearMaps() {
            ClearMapsPool();
            UpdateAllMapListsAndUls();
        }

        function AddController() {
            AddNewObjectToStorage("controllerFile", controllersPoolName, UpdateAllControllerListsAndUls, ValidateControllerText);
        }

        function ClearControllers() {
            ClearControllersPool();
            UpdateAllControllerListsAndUls();
        }

        function GetDataFromBotInfoDiv(infoDiv) {
            let botName = null;
            let type = null;
            let score = null;

            for (let i = 0; i < infoDiv.children.length; ++i) {
                if (infoDiv.children[i].name == "name")
                    botName = infoDiv.children[i];
                if (infoDiv.children[i].name == "type")
                    type = infoDiv.children[i];
                if (infoDiv.children[i].name == "score")
                    score = infoDiv.children[i];
            }

            return {
                botName: botName,
                type: type,
                score: score
            };
        }

        function StartGame() {
            StopAutoStep();

            let select = document.getElementById("mapList");
            if (select.selectedIndex == -1)
                return null;
            let mapText = GetObjectFromStorageByName(select.options[select.selectedIndex].text);
            gameScene.mapInfo = MapInfo.LoadMapFromJson(mapText);

            bots = []
            let botsList = document.getElementById("botsList");
            for (let i = 0; i < botsList.children.length; ++i) {
                let infoDiv = botsList.children[i].children[0];
                let data = GetDataFromBotInfoDiv(infoDiv);

                if (data.type.selectedIndex == -1)
                    throw "select for ai has index=-1";
                if (data.type.options[data.type.selectedIndex].text == "none")
                    continue;

                let controllerScript = GetObjectFromStorageByName(data.type.options[data.type.selectedIndex].text);
                let controller = LoadControllerFromString(controllerScript);
                bots.push(new Bot(0, 0, 0, controller, data.botName.value, colors[i]));
            }

            gameScene = new Scene(gameScene.mapInfo, bots, false, true, 100,
                //Hack when bots length = 0, call Update after scene assign 
                function() {
                    setTimeout(UpdateRender, 0);
                });
        }

        function UpdateRender() {
            let x = document.getElementById("tileSize").value;
            let canvas = document.getElementById("main-window");
            gameScene.Render(canvas, x);
            document.getElementById('turnsCount').innerHTML = gameScene.mapInfo.turns;
            let scores = gameScene.CalcScores()
            for (let i = 0; i < scores.length; ++i) {
                GetDataFromBotInfoDiv(document.getElementById(scores[i].botName + "InfoDiv")).score.innerHTML = scores[i].value;
            }
        }

        function StopAutoStep() {
            if (startedAutoStep) {
                clearInterval(timerId);
                startedAutoStep = false;
            }
        }

        function AutoStep() {
            if (startedAutoStep) {
                clearInterval(timerId);
            } else {
                timerId = setInterval(function() {
                        if (gameScene.mapInfo.turns > 0) {
                            NextStepWithTimer();
                        } else {
                            StopAutoStep();
                        }
                    },
                    document.getElementById("turnTime").value,
                    document.getElementById("botTurnTime").value);
            }
            startedAutoStep = !startedAutoStep;
        }

        function NextStep() {
            StopAutoStep();
            let scores = gameScene.NextStep();
            UpdateRender();
        }

        function NextStepWithTimer() {
            gameScene.NextStepWithTimer(document.getElementById("botTurnTime").value, UpdateRender);
        }

        function ResetMapUI() {
            let ul = document.getElementById("botsList");
            while (ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }

            document.getElementById('mapWidth').innerHTML = 0;
            document.getElementById('mapHeight').innerHTML = 0;
            document.getElementById('turnsCount').innerHTML = 0;
            let canvas = document.getElementById("main-window");
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        function AutoSizeRender() {
            let tileSize = document.getElementById("tileSize");
            let size = GetGameCanvasSuitableSize();
            size = Math.min(Math.max(size, tileSize.min), tileSize.max);
            tileSize.value = size;
            tileSize.oninput();
            UpdateOutputForInputRange("tileSizeOutput", size)
            UpdateRender();
        }

        function SetMap() {
            StopAutoStep()

            let select = document.getElementById("mapList");
            let canvas = document.getElementById("main-window");

            ResetMapUI();

            if (select.selectedIndex == -1)
                return null;

            let mapText = GetObjectFromStorageByName(select.options[select.selectedIndex].text);
            gameScene = new Scene(MapInfo.LoadMapFromJson(mapText), []);

            document.getElementById('mapWidth').innerHTML = gameScene.mapInfo.width;
            document.getElementById('mapHeight').innerHTML = gameScene.mapInfo.height;

            let botsList = document.getElementById("botsList");
            for (let i = 0; i < gameScene.mapInfo.spawns.length; ++i) {
                let botName = "bot#" + i;

                let botInfoDiv = document.createElement("div");
                botInfoDiv.id = botName + "InfoDiv";

                let selectList = document.createElement("select");
                selectList.name = "type";
                UpdateSelect(selectList, [...["none"], ...GetControllersNames()]);

                let input = document.createElement("input");
                input.value = botName;
                input.name = "name";
                input.onchange = function(text) {
                    gameScene.RenameBot(botInfoDiv.id.replace("InfoDiv", ""), input.value);
                    botInfoDiv.id = input.value + "InfoDiv";
                    UpdateRender();
                }

                let scoreLabel = document.createElement("label");
                scoreLabel.innerHTML = 0;
                scoreLabel.name = "score";

                botInfoDiv.appendChild(input);
                botInfoDiv.appendChild(selectList);
                botInfoDiv.appendChild(scoreLabel)

                let li = document.createElement("li");
                li.appendChild(botInfoDiv);

                botsList.appendChild(li);
            }

            document.getElementById('turnsCount').innerHTML = gameScene.mapInfo.turns;

            AutoSizeRender();
        }

        function InitAceEditor(name, modePath) {
            let editor = ace.edit(name);
            editor.setTheme("ace/theme/clouds");
            editor.session.setMode({
                path: modePath,
                inline: true
            });
            return editor;
        }

        function UpdateAllMapListsAndUls() {
            UpdateSelect(document.getElementById("mapList"), GetMapsNames());
            UpdateEditorUl(document.getElementById("mapsUl"), GetMapsNames(), DeleteMap, SetMapToEditor);
            SetMap();
        }

        function UpdateAllControllerListsAndUls() {
            UpdateEditorUl(document.getElementById("controllerUl"), GetControllersNames(), DeleteController, SetControllerToEditor);
            SetMap();
        }

        function InitControllerEditor() {
            let controllerFileName = document.getElementById("controllerFileName");
            controllerFileName.value = "";
            controllerEditor = InitAceEditor("controllerEditorText", "ace/mode/javascript");
            let controllersNames = GetControllersNames();
            if (controllersNames.length > 0) {
                controllerFileName.value = controllersNames[0];
                controllerEditor.setValue(GetObjectFromStorageByName(controllerFileName.value));
            }
        }

        function InitMapEditor() {
            let mapFileName = document.getElementById("mapFileName");
            mapFileName.value = "";
            mapEditor = InitAceEditor("mapEditorText", "ace/mode/json");
            let mapsNames = GetMapsNames();
            if (mapsNames.length > 0) {
                mapFileName.value = mapsNames[0];
                mapEditor.setValue((GetObjectFromStorageByName(mapFileName.value)));
            }
        }

        function InitEditors() {
            InitControllerEditor();
            InitMapEditor();
        }

        function GetGameCanvasSuitableSize() {
            if (gameScene.mapInfo === null || gameScene.mapInfo === undefined)
                return;
            let mainWindowContainer = document.getElementById("mainWindowContainer");
            let width = Math.floor(mainWindowContainer.offsetWidth / gameScene.mapInfo.width);
            let height = Math.floor(mainWindowContainer.offsetHeight / gameScene.mapInfo.height);

            return Math.min(width, height);
        }

        function UpdateRangeInputs() {
            document.getElementById("turnTime").oninput();
            document.getElementById("botTurnTime").oninput();
            document.getElementById("tileSize").oninput();
        }

        let controllerEditor = null;
        let mapEditor = null;

        let gameScene = null;
        let mapEditorScene = null;

        let startedAutoStep = false;
        let timerId = null;

        const colors = [
            "white",
            "red",
            "orange",
            "yellow",
            "green",
            "blue",
            "indigo",
            "violet"
        ];

        //preload image
        new Tree();
        new Wall();
        new Field();
        new Bot();
        new Snowball();

        window.onload = function() {
            InitTabs();
            InitEditors();
            UpdateAllControllerListsAndUls();
            UpdateAllMapListsAndUls();
            UpdateRangeInputs();
        }
    </script>
</body>

</html>